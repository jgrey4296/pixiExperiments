// wrap-start.frag.js
(function (root, factory) {
    if (typeof define === 'function' && define.amd) {
        define(['underscore','phaser'], factory);
    } else if (typeof exports === 'object') {
        var _ = require('underscore'),
            phaser = require('phaser');
        module.exports = factory(_);
    } else {
        // change "myLib" to whatever your library is called
        root.main = factory(root._,root.phaser);
    }
}(this, function (_,Phaser) {

    
/**
 * @license almond 0.3.1 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */
//Going sloppy to avoid 'use strict' string cost, but strict practices should
//be followed.
/*jslint sloppy: true */
/*global setTimeout: false */

var requirejs, require, define;
(function (undef) {
    var main, req, makeMap, handlers,
        defined = {},
        waiting = {},
        config = {},
        defining = {},
        hasOwn = Object.prototype.hasOwnProperty,
        aps = [].slice,
        jsSuffixRegExp = /\.js$/;

    function hasProp(obj, prop) {
        return hasOwn.call(obj, prop);
    }

    /**
     * Given a relative module name, like ./something, normalize it to
     * a real name that can be mapped to a path.
     * @param {String} name the relative name
     * @param {String} baseName a real name that the name arg is relative
     * to.
     * @returns {String} normalized name
     */
    function normalize(name, baseName) {
        var nameParts, nameSegment, mapValue, foundMap, lastIndex,
            foundI, foundStarMap, starI, i, j, part,
            baseParts = baseName && baseName.split("/"),
            map = config.map,
            starMap = (map && map['*']) || {};

        //Adjust any relative paths.
        if (name && name.charAt(0) === ".") {
            //If have a base name, try to normalize against it,
            //otherwise, assume it is a top-level require that will
            //be relative to baseUrl in the end.
            if (baseName) {
                name = name.split('/');
                lastIndex = name.length - 1;

                // Node .js allowance:
                if (config.nodeIdCompat && jsSuffixRegExp.test(name[lastIndex])) {
                    name[lastIndex] = name[lastIndex].replace(jsSuffixRegExp, '');
                }

                //Lop off the last part of baseParts, so that . matches the
                //"directory" and not name of the baseName's module. For instance,
                //baseName of "one/two/three", maps to "one/two/three.js", but we
                //want the directory, "one/two" for this normalization.
                name = baseParts.slice(0, baseParts.length - 1).concat(name);

                //start trimDots
                for (i = 0; i < name.length; i += 1) {
                    part = name[i];
                    if (part === ".") {
                        name.splice(i, 1);
                        i -= 1;
                    } else if (part === "..") {
                        if (i === 1 && (name[2] === '..' || name[0] === '..')) {
                            //End of the line. Keep at least one non-dot
                            //path segment at the front so it can be mapped
                            //correctly to disk. Otherwise, there is likely
                            //no path mapping for a path starting with '..'.
                            //This can still fail, but catches the most reasonable
                            //uses of ..
                            break;
                        } else if (i > 0) {
                            name.splice(i - 1, 2);
                            i -= 2;
                        }
                    }
                }
                //end trimDots

                name = name.join("/");
            } else if (name.indexOf('./') === 0) {
                // No baseName, so this is ID is resolved relative
                // to baseUrl, pull off the leading dot.
                name = name.substring(2);
            }
        }

        //Apply map config if available.
        if ((baseParts || starMap) && map) {
            nameParts = name.split('/');

            for (i = nameParts.length; i > 0; i -= 1) {
                nameSegment = nameParts.slice(0, i).join("/");

                if (baseParts) {
                    //Find the longest baseName segment match in the config.
                    //So, do joins on the biggest to smallest lengths of baseParts.
                    for (j = baseParts.length; j > 0; j -= 1) {
                        mapValue = map[baseParts.slice(0, j).join('/')];

                        //baseName segment has  config, find if it has one for
                        //this name.
                        if (mapValue) {
                            mapValue = mapValue[nameSegment];
                            if (mapValue) {
                                //Match, update name to the new value.
                                foundMap = mapValue;
                                foundI = i;
                                break;
                            }
                        }
                    }
                }

                if (foundMap) {
                    break;
                }

                //Check for a star map match, but just hold on to it,
                //if there is a shorter segment match later in a matching
                //config, then favor over this star map.
                if (!foundStarMap && starMap && starMap[nameSegment]) {
                    foundStarMap = starMap[nameSegment];
                    starI = i;
                }
            }

            if (!foundMap && foundStarMap) {
                foundMap = foundStarMap;
                foundI = starI;
            }

            if (foundMap) {
                nameParts.splice(0, foundI, foundMap);
                name = nameParts.join('/');
            }
        }

        return name;
    }

    function makeRequire(relName, forceSync) {
        return function () {
            //A version of a require function that passes a moduleName
            //value for items that may need to
            //look up paths relative to the moduleName
            var args = aps.call(arguments, 0);

            //If first arg is not require('string'), and there is only
            //one arg, it is the array form without a callback. Insert
            //a null so that the following concat is correct.
            if (typeof args[0] !== 'string' && args.length === 1) {
                args.push(null);
            }
            return req.apply(undef, args.concat([relName, forceSync]));
        };
    }

    function makeNormalize(relName) {
        return function (name) {
            return normalize(name, relName);
        };
    }

    function makeLoad(depName) {
        return function (value) {
            defined[depName] = value;
        };
    }

    function callDep(name) {
        if (hasProp(waiting, name)) {
            var args = waiting[name];
            delete waiting[name];
            defining[name] = true;
            main.apply(undef, args);
        }

        if (!hasProp(defined, name) && !hasProp(defining, name)) {
            throw new Error('No ' + name);
        }
        return defined[name];
    }

    //Turns a plugin!resource to [plugin, resource]
    //with the plugin being undefined if the name
    //did not have a plugin prefix.
    function splitPrefix(name) {
        var prefix,
            index = name ? name.indexOf('!') : -1;
        if (index > -1) {
            prefix = name.substring(0, index);
            name = name.substring(index + 1, name.length);
        }
        return [prefix, name];
    }

    /**
     * Makes a name map, normalizing the name, and using a plugin
     * for normalization if necessary. Grabs a ref to plugin
     * too, as an optimization.
     */
    makeMap = function (name, relName) {
        var plugin,
            parts = splitPrefix(name),
            prefix = parts[0];

        name = parts[1];

        if (prefix) {
            prefix = normalize(prefix, relName);
            plugin = callDep(prefix);
        }

        //Normalize according
        if (prefix) {
            if (plugin && plugin.normalize) {
                name = plugin.normalize(name, makeNormalize(relName));
            } else {
                name = normalize(name, relName);
            }
        } else {
            name = normalize(name, relName);
            parts = splitPrefix(name);
            prefix = parts[0];
            name = parts[1];
            if (prefix) {
                plugin = callDep(prefix);
            }
        }

        //Using ridiculous property names for space reasons
        return {
            f: prefix ? prefix + '!' + name : name, //fullName
            n: name,
            pr: prefix,
            p: plugin
        };
    };

    function makeConfig(name) {
        return function () {
            return (config && config.config && config.config[name]) || {};
        };
    }

    handlers = {
        require: function (name) {
            return makeRequire(name);
        },
        exports: function (name) {
            var e = defined[name];
            if (typeof e !== 'undefined') {
                return e;
            } else {
                return (defined[name] = {});
            }
        },
        module: function (name) {
            return {
                id: name,
                uri: '',
                exports: defined[name],
                config: makeConfig(name)
            };
        }
    };

    main = function (name, deps, callback, relName) {
        var cjsModule, depName, ret, map, i,
            args = [],
            callbackType = typeof callback,
            usingExports;

        //Use name if no relName
        relName = relName || name;

        //Call the callback to define the module, if necessary.
        if (callbackType === 'undefined' || callbackType === 'function') {
            //Pull out the defined dependencies and pass the ordered
            //values to the callback.
            //Default to [require, exports, module] if no deps
            deps = !deps.length && callback.length ? ['require', 'exports', 'module'] : deps;
            for (i = 0; i < deps.length; i += 1) {
                map = makeMap(deps[i], relName);
                depName = map.f;

                //Fast path CommonJS standard dependencies.
                if (depName === "require") {
                    args[i] = handlers.require(name);
                } else if (depName === "exports") {
                    //CommonJS module spec 1.1
                    args[i] = handlers.exports(name);
                    usingExports = true;
                } else if (depName === "module") {
                    //CommonJS module spec 1.1
                    cjsModule = args[i] = handlers.module(name);
                } else if (hasProp(defined, depName) ||
                           hasProp(waiting, depName) ||
                           hasProp(defining, depName)) {
                    args[i] = callDep(depName);
                } else if (map.p) {
                    map.p.load(map.n, makeRequire(relName, true), makeLoad(depName), {});
                    args[i] = defined[depName];
                } else {
                    throw new Error(name + ' missing ' + depName);
                }
            }

            ret = callback ? callback.apply(defined[name], args) : undefined;

            if (name) {
                //If setting exports via "module" is in play,
                //favor that over return value and exports. After that,
                //favor a non-undefined return value over exports use.
                if (cjsModule && cjsModule.exports !== undef &&
                        cjsModule.exports !== defined[name]) {
                    defined[name] = cjsModule.exports;
                } else if (ret !== undef || !usingExports) {
                    //Use the return value from the function.
                    defined[name] = ret;
                }
            }
        } else if (name) {
            //May just be an object definition for the module. Only
            //worry about defining if have a module name.
            defined[name] = callback;
        }
    };

    requirejs = require = req = function (deps, callback, relName, forceSync, alt) {
        if (typeof deps === "string") {
            if (handlers[deps]) {
                //callback in this case is really relName
                return handlers[deps](callback);
            }
            //Just return the module wanted. In this scenario, the
            //deps arg is the module name, and second arg (if passed)
            //is just the relName.
            //Normalize module name, if it contains . or ..
            return callDep(makeMap(deps, callback).f);
        } else if (!deps.splice) {
            //deps is a config object, not an array.
            config = deps;
            if (config.deps) {
                req(config.deps, config.callback);
            }
            if (!callback) {
                return;
            }

            if (callback.splice) {
                //callback is an array, which means it is a dependency list.
                //Adjust args if there are dependencies
                deps = callback;
                callback = relName;
                relName = null;
            } else {
                deps = undef;
            }
        }

        //Support require(['a'])
        callback = callback || function () {};

        //If relName is a function, it is an errback handler,
        //so remove it.
        if (typeof relName === 'function') {
            relName = forceSync;
            forceSync = alt;
        }

        //Simulate async callback;
        if (forceSync) {
            main(undef, deps, callback, relName);
        } else {
            //Using a non-zero value because of concern for what old browsers
            //do, and latest browsers "upgrade" to 4 if lower value is used:
            //http://www.whatwg.org/specs/web-apps/current-work/multipage/timers.html#dom-windowtimers-settimeout:
            //If want a value immediately, use require('id') instead -- something
            //that works in almond on the global level, but not guaranteed and
            //unlikely to work in other AMD implementations.
            setTimeout(function () {
                main(undef, deps, callback, relName);
            }, 4);
        }

        return req;
    };

    /**
     * Just drops the config on the floor, but returns req in case
     * the config return value is used.
     */
    req.config = function (cfg) {
        return req(cfg);
    };

    /**
     * Expose module registry for debugging and tooling
     */
    requirejs._defined = defined;

    define = function (name, deps, callback) {
        if (typeof name !== 'string') {
            throw new Error('See almond README: incorrect module build, no module name');
        }

        //This module may not have dependencies
        if (!deps.splice) {
            //deps is not an array, so probably means
            //an object literal or factory function for
            //the value. Adjust args.
            callback = deps;
            deps = [];
        }

        if (!hasProp(defined, name) && !hasProp(waiting, name)) {
            waiting[name] = [name, deps, callback];
        }
    };

    define.amd = {
        jQuery: true
    };
}());

define("node_modules/almond/almond", function(){});

/**
   @module PhaserGame/GameState/Boot
 */
define('src/GameState/Boot',['underscore','phaser'],function(_,Phaser){
    /**
       @alias module:PhaserGame/GameState/Boot
     */
    var Boot = function(game){
    };

    /**
       @method preload
     */
    Boot.prototype.preload = function(){
        //load a loading bar image
        this.game.load.image("loadImage","data/loadImage.png");
        //Turn on for debugging:
        //this.game.time.advancedTiming = true;
    };

    /** @method create */
    Boot.prototype.create = function(){
        console.log("Booting");
        //add the loading bar to the screen
        //Transition to next state
        this.loadBar = this.add.sprite(0,this.game.height/2,'loadImage');
        this.loadBar.anchor.setTo(0.5,0.5);
        this.loadBarTween = this.game.add.tween(this.loadBar).to({x:this.game.width},
                                                                 1000, Phaser.Easing.Quadratic.InOut, false);
        this.loadBarTween.onComplete.add(function(){
            this.game.state.start('PreLoadAssets');
        },this);
        this.loadBarTween.start();
        //this.game.state.start('PreLoadAssets');
    };
    /** method update */
    Boot.prototype.update = function(){

    };

    /** @method render */
    Boot.prototype.render = function(){
        //this.game.debug.text(this.game.time.fps || '--', 2, 14, "#ffffff");
        //console.log("FPS:",game.time.fps);

    };

    
    return Boot;
});

/**
 * @license RequireJS text 2.0.5 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */
/*jslint regexp: true */
/*global require: false, XMLHttpRequest: false, ActiveXObject: false,
  define: false, window: false, process: false, Packages: false,
  java: false, location: false */

define('text',['module'], function (module) {
    'use strict';

    var text, fs,
        progIds = ['Msxml2.XMLHTTP', 'Microsoft.XMLHTTP', 'Msxml2.XMLHTTP.4.0'],
        xmlRegExp = /^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,
        bodyRegExp = /<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,
        hasLocation = typeof location !== 'undefined' && location.href,
        defaultProtocol = hasLocation && location.protocol && location.protocol.replace(/\:/, ''),
        defaultHostName = hasLocation && location.hostname,
        defaultPort = hasLocation && (location.port || undefined),
        buildMap = [],
        masterConfig = (module.config && module.config()) || {};

    text = {
        version: '2.0.5',

        strip: function (content) {
            //Strips <?xml ...?> declarations so that external SVG and XML
            //documents can be added to a document without worry. Also, if the string
            //is an HTML document, only the part inside the body tag is returned.
            if (content) {
                content = content.replace(xmlRegExp, "");
                var matches = content.match(bodyRegExp);
                if (matches) {
                    content = matches[1];
                }
            } else {
                content = "";
            }
            return content;
        },

        jsEscape: function (content) {
            return content.replace(/(['\\])/g, '\\$1')
                .replace(/[\f]/g, "\\f")
                .replace(/[\b]/g, "\\b")
                .replace(/[\n]/g, "\\n")
                .replace(/[\t]/g, "\\t")
                .replace(/[\r]/g, "\\r")
                .replace(/[\u2028]/g, "\\u2028")
                .replace(/[\u2029]/g, "\\u2029");
        },

        createXhr: masterConfig.createXhr || function () {
            //Would love to dump the ActiveX crap in here. Need IE 6 to die first.
            var xhr, i, progId;
            if (typeof XMLHttpRequest !== "undefined") {
                return new XMLHttpRequest();
            } else if (typeof ActiveXObject !== "undefined") {
                for (i = 0; i < 3; i += 1) {
                    progId = progIds[i];
                    try {
                        xhr = new ActiveXObject(progId);
                    } catch (e) {}

                    if (xhr) {
                        progIds = [progId];  // so faster next time
                        break;
                    }
                }
            }

            return xhr;
        },

        /**
         * Parses a resource name into its component parts. Resource names
         * look like: module/name.ext!strip, where the !strip part is
         * optional.
         * @param {String} name the resource name
         * @returns {Object} with properties "moduleName", "ext" and "strip"
         * where strip is a boolean.
         */
        parseName: function (name) {
            var modName, ext, temp,
                strip = false,
                index = name.indexOf("."),
                isRelative = name.indexOf('./') === 0 ||
                             name.indexOf('../') === 0;

            if (index !== -1 && (!isRelative || index > 1)) {
                modName = name.substring(0, index);
                ext = name.substring(index + 1, name.length);
            } else {
                modName = name;
            }

            temp = ext || modName;
            index = temp.indexOf("!");
            if (index !== -1) {
                //Pull off the strip arg.
                strip = temp.substring(index + 1) === "strip";
                temp = temp.substring(0, index);
                if (ext) {
                    ext = temp;
                } else {
                    modName = temp;
                }
            }

            return {
                moduleName: modName,
                ext: ext,
                strip: strip
            };
        },

        xdRegExp: /^((\w+)\:)?\/\/([^\/\\]+)/,

        /**
         * Is an URL on another domain. Only works for browser use, returns
         * false in non-browser environments. Only used to know if an
         * optimized .js version of a text resource should be loaded
         * instead.
         * @param {String} url
         * @returns Boolean
         */
        useXhr: function (url, protocol, hostname, port) {
            var uProtocol, uHostName, uPort,
                match = text.xdRegExp.exec(url);
            if (!match) {
                return true;
            }
            uProtocol = match[2];
            uHostName = match[3];

            uHostName = uHostName.split(':');
            uPort = uHostName[1];
            uHostName = uHostName[0];

            return (!uProtocol || uProtocol === protocol) &&
                   (!uHostName || uHostName.toLowerCase() === hostname.toLowerCase()) &&
                   ((!uPort && !uHostName) || uPort === port);
        },

        finishLoad: function (name, strip, content, onLoad) {
            content = strip ? text.strip(content) : content;
            if (masterConfig.isBuild) {
                buildMap[name] = content;
            }
            onLoad(content);
        },

        load: function (name, req, onLoad, config) {
            //Name has format: some.module.filext!strip
            //The strip part is optional.
            //if strip is present, then that means only get the string contents
            //inside a body tag in an HTML string. For XML/SVG content it means
            //removing the <?xml ...?> declarations so the content can be inserted
            //into the current doc without problems.

            // Do not bother with the work if a build and text will
            // not be inlined.
            if (config.isBuild && !config.inlineText) {
                onLoad();
                return;
            }

            masterConfig.isBuild = config.isBuild;

            var parsed = text.parseName(name),
                nonStripName = parsed.moduleName +
                    (parsed.ext ? '.' + parsed.ext : ''),
                url = req.toUrl(nonStripName),
                useXhr = (masterConfig.useXhr) ||
                         text.useXhr;

            //Load the text. Use XHR if possible and in a browser.
            if (!hasLocation || useXhr(url, defaultProtocol, defaultHostName, defaultPort)) {
                text.get(url, function (content) {
                    text.finishLoad(name, parsed.strip, content, onLoad);
                }, function (err) {
                    if (onLoad.error) {
                        onLoad.error(err);
                    }
                });
            } else {
                //Need to fetch the resource across domains. Assume
                //the resource has been optimized into a JS module. Fetch
                //by the module name + extension, but do not include the
                //!strip part to avoid file system issues.
                req([nonStripName], function (content) {
                    text.finishLoad(parsed.moduleName + '.' + parsed.ext,
                                    parsed.strip, content, onLoad);
                });
            }
        },

        write: function (pluginName, moduleName, write, config) {
            if (buildMap.hasOwnProperty(moduleName)) {
                var content = text.jsEscape(buildMap[moduleName]);
                write.asModule(pluginName + "!" + moduleName,
                               "define(function () { return '" +
                                   content +
                               "';});\n");
            }
        },

        writeFile: function (pluginName, moduleName, req, write, config) {
            var parsed = text.parseName(moduleName),
                extPart = parsed.ext ? '.' + parsed.ext : '',
                nonStripName = parsed.moduleName + extPart,
                //Use a '.js' file name so that it indicates it is a
                //script that can be loaded across domains.
                fileName = req.toUrl(parsed.moduleName + extPart) + '.js';

            //Leverage own load() method to load plugin value, but only
            //write out values that do not have the strip argument,
            //to avoid any potential issues with ! in file names.
            text.load(nonStripName, req, function (value) {
                //Use own write() method to construct full module value.
                //But need to create shell that translates writeFile's
                //write() to the right interface.
                var textWrite = function (contents) {
                    return write(fileName, contents);
                };
                textWrite.asModule = function (moduleName, contents) {
                    return write.asModule(moduleName, fileName, contents);
                };

                text.write(pluginName, nonStripName, textWrite, config);
            }, config);
        }
    };

    if (masterConfig.env === 'node' || (!masterConfig.env &&
            typeof process !== "undefined" &&
            process.versions &&
            !!process.versions.node)) {
        //Using special require.nodeRequire, something added by r.js.
        fs = require.nodeRequire('fs');

        text.get = function (url, callback) {
            var file = fs.readFileSync(url, 'utf8');
            //Remove BOM (Byte Mark Order) from utf8 files if it is there.
            if (file.indexOf('\uFEFF') === 0) {
                file = file.substring(1);
            }
            callback(file);
        };
    } else if (masterConfig.env === 'xhr' || (!masterConfig.env &&
            text.createXhr())) {
        text.get = function (url, callback, errback, headers) {
            var xhr = text.createXhr(), header;
            xhr.open('GET', url, true);

            //Allow plugins direct access to xhr headers
            if (headers) {
                for (header in headers) {
                    if (headers.hasOwnProperty(header)) {
                        xhr.setRequestHeader(header.toLowerCase(), headers[header]);
                    }
                }
            }

            //Allow overrides specified in config
            if (masterConfig.onXhr) {
                masterConfig.onXhr(xhr, url);
            }

            xhr.onreadystatechange = function (evt) {
                var status, err;
                //Do not explicitly handle errors, those should be
                //visible via console output in the browser.
                if (xhr.readyState === 4) {
                    status = xhr.status;
                    if (status > 399 && status < 600) {
                        //An http 4xx or 5xx error. Signal an error.
                        err = new Error(url + ' HTTP status: ' + status);
                        err.xhr = xhr;
                        errback(err);
                    } else {
                        callback(xhr.responseText);
                    }
                }
            };
            xhr.send(null);
        };
    } else if (masterConfig.env === 'rhino' || (!masterConfig.env &&
            typeof Packages !== 'undefined' && typeof java !== 'undefined')) {
        //Why Java, why is this so awkward?
        text.get = function (url, callback) {
            var stringBuffer, line,
                encoding = "utf-8",
                file = new java.io.File(url),
                lineSeparator = java.lang.System.getProperty("line.separator"),
                input = new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(file), encoding)),
                content = '';
            try {
                stringBuffer = new java.lang.StringBuffer();
                line = input.readLine();

                // Byte Order Mark (BOM) - The Unicode Standard, version 3.0, page 324
                // http://www.unicode.org/faq/utf_bom.html

                // Note that when we use utf-8, the BOM should appear as "EF BB BF", but it doesn't due to this bug in the JDK:
                // http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4508058
                if (line && line.length() && line.charAt(0) === 0xfeff) {
                    // Eat the BOM, since we've already found the encoding on this file,
                    // and we plan to concatenating this buffer with others; the BOM should
                    // only appear at the top of a file.
                    line = line.substring(1);
                }

                stringBuffer.append(line);

                while ((line = input.readLine()) !== null) {
                    stringBuffer.append(lineSeparator);
                    stringBuffer.append(line);
                }
                //Make sure we return a JavaScript string and not a Java string.
                content = String(stringBuffer.toString()); //String
            } finally {
                input.close();
            }
            callback(content);
        };
    }

    return text;
});

/** @license
 * RequireJS plugin for loading JSON files
 * - depends on Text plugin and it was HEAVILY "inspired" by it as well.
 * Author: Miller Medeiros
 * Version: 0.4.0 (2014/04/10)
 * Released under the MIT license
 */
define('json',['text'], function(text){

    var CACHE_BUST_QUERY_PARAM = 'bust',
        CACHE_BUST_FLAG = '!bust',
        jsonParse = (typeof JSON !== 'undefined' && typeof JSON.parse === 'function')? JSON.parse : function(val){
            return eval('('+ val +')'); //quick and dirty
        },
        buildMap = {};

    function cacheBust(url){
        url = url.replace(CACHE_BUST_FLAG, '');
        url += (url.indexOf('?') < 0)? '?' : '&';
        return url + CACHE_BUST_QUERY_PARAM +'='+ Math.round(2147483647 * Math.random());
    }

    //API
    return {

        load : function(name, req, onLoad, config) {
            if (( config.isBuild && (config.inlineJSON === false || name.indexOf(CACHE_BUST_QUERY_PARAM +'=') !== -1)) || (req.toUrl(name).indexOf('empty:') === 0)) {
                //avoid inlining cache busted JSON or if inlineJSON:false
                //and don't inline files marked as empty!
                onLoad(null);
            } else {
                text.get(req.toUrl(name), function(data){
                    var parsed;
                    if (config.isBuild) {
                        buildMap[name] = data;
                        onLoad(data);
                    } else {
                        try {
                            parsed = jsonParse(data);
                        } catch (e) {
                            onLoad.error(e);
                        }
                        onLoad(parsed);
                    }
                },
                    onLoad.error, {
                        accept: 'application/json'
                    }
                );
            }
        },

        normalize : function (name, normalize) {
            // used normalize to avoid caching references to a "cache busted" request
            if (name.indexOf(CACHE_BUST_FLAG) !== -1) {
                name = cacheBust(name);
            }
            // resolve any relative paths
            return normalize(name);
        },

        //write method based on RequireJS official text plugin by James Burke
        //https://github.com/jrburke/requirejs/blob/master/text.js
        write : function(pluginName, moduleName, write){
            if(moduleName in buildMap){
                var content = buildMap[moduleName];
                write('define("'+ pluginName +'!'+ moduleName +'", function(){ return '+ content +';});\n');
            }
        }

    };
});


define("json!data/assets.json", function(){ return [
    {
        "id" : 0,
        "name" : "tree",
        "fileName": "glitch_tree_sheet.png",
        "type" : "spritesheet",
        "frames" : {
            "x": 318,
            "y" : 250
        }
    },
    {
        "id" : 1,
        "name" : "rock",
        "fileName" : "glitch_rock_metal.png",
        "type" : "image"
    },
    {
        "id" : 2,
        "name" : "pig",
        "fileName" : "glitch_pig.png",
        "type" : "spritesheet",
        "frames" : {
            "x" : 87,
            "y" : 64
        }
    },
    {
        "id" : 3,
        "name" : "simpleTile",
        "fileName" : "simpleTile_32x32.png",
        "type" : "image",
        "size" : { "x" : 32, "y" : 32 }
    },
    {
        "id:" : 4,
        "name" : "hillyBackground",
        "fileName" : "background.png",
        "type" : "image"
    },
    {
        "id" : 5,
        "name" : "countryBackground",
        "fileName" : "countryBackground.png",
        "type" : "image"
    },
    {
        "id" : 6,
        "name" : "bubble-border",
        "fileName" : "textbubble.png",
        "type" : "spritesheet",
        "frames" : {
            "x" : 9,
            "y" : 9
        }

    },
    {
        "id" : 7,
        "name" : "bubble-tail",
        "fileName" : "textbubbleStart.png",
        "type" : "image"        
    },
    {
        "id" : 8,
        "name" : "8bitoperator",
        "type" : "bitmapfont",
        "url"  : "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACAAQMAAAD58POIAAAABlBMVEUAAAD///+l2Z/dAAAAAXRSTlMAQObYZgAABF9JREFUSMftlEur00AUx6cI0UXqxd0UpXXh0sWEgShYLCgIih9iSmC6SW/FC1Kx1kdFXRTrzoZC1W8gBLrxlVBINxOzkwbxUQJ1c9WWQL0XveqZpFyrH0E8q5nfnMd/zpkEEebeua2eOHGC5Hp6pUVQvRyJIL++vo61nm56GIlYr1g2Sk11EMp05arIi8V6HIvcM3TZmlYe9jmY38u0c10kHM8cU37pN2AJaKYgBEASsC7BRAK/65nvKefNpv8tc6eTgNq4tEx6HWqKmQxZgtZu0iKAy73YWysm0t/b6G9TxVDrM7hoG+W6jKsKFgalrD6PBNK6jqGo0ivf8OG+y5CmmH+8zmUs8nvkS9hnfo/muZhHbQnMnC0BBSXaKtjD/a52fQkaAArct+ZtdLlHapbNrkJIIwnRpMdLlgUAcRCi7eYosMY8dgDoAJp10JFKIvMoCGiydBiH66emrClMMMcAUC+H4RvdyLWZAB84E/HGxobOctcJmn8YdY4jP4lSx5RA0WQMmWgyiURoY4FTEFNKdVOC7XjtvRwDAGIGVAVtKsbIt6TLpiOBrsrJfUtCPKqI7cXeThFdbklQEQWlkWrMWbE2iT7I5Z4pnXGkzhJeuPPowFDXywtYs2H5JyUiig19wBgSjnubEkqFZxi6PZzCsCGYXBv43mQ0GCgcnmH0aoNQPRhFLd32OLoQ65yepPqrEY/1AefQQgAzmYMblCfg2JSSa08OBZ4RGZAUPBSoUnhwd88TBJaGlGiilJj4MNKsKKjDDWy+0wJAUH0GlT9uhjbPtugXSza0uB1rbQliaFwbNW/ypLt9noMZvlHQwoNXcKMdtouatTDfqWjxmfldFzxwuQseGC1+bG3PypADuxASPkGXXjMXcgQUu1a0GT5CupcAj+KdpHcAuGtN7iSPI6/sbAH47nZB241o1KH7HQwAjijXWnKceQBgnxUAUmZL3yJo61umBSDT07PuPa4SJD+sNfDoVYLhHq6yBOT6vNzT1z3aFBLszcBX6UIOAQNferQbPlQZ55V6CtZKzG8Zo4dSXVpFZfVE6SHnDHIOgg7YxATaSBwBAO50srnTI6BUm3dl94MOZS6At3ZjiFF9PoUj5rZI9aFNPAxV9AQ8ndUO2mSYgjFtbPdI1bKJKx+uXutCDuBplfpWZXO8BH1y4QwS2JM5nJiKUCqFEMUMXzQdud7byfPkH9SBTSngxwRMGKYvD4tlXh0MTBcAGDXrpwwFQC0A8PF5Z8O8ZSmlT+CRA1B+4tHsxccqzwII7SIATrPnHmNetXml08cJyFy0SMm3OUNgElTPnTKQtH3VQQLMW8XT6pAb+w8twVHoqFIeDg/qR+7LKlfOI+wZx+adN8bZw+jrcxCuYuFJD5Ta2nsV5doyh9yJ+ZSFL5uqszyVLSxbbaSwXdCiQ6ziXQck4sxtjFbBQSpwCRYrOWpj1PgNGlAFFdAfpnjOym4nHpjmKlAVCFm17Az9t3/TfgG1wI+/NyjOhQAAAABJRU5ErkJggg==",
        "data" : "<?xml version='1.0'?><font><info face='8bitoperator' size='11' bold='0' italic='0' charset='' unicode='1' stretchH='100' smooth='0' aa='0' padding='0,0,0,0' spacing='1,1' outline='0'/><common lineHeight='16' base='13' scaleW='128' scaleH='128' pages='1' packed='0' alphaChnl='0' redChnl='4' greenChnl='4' blueChnl='4'/><pages><page id='0' file='8bitoperator.png' /></pages><chars count='179'><char id='32' x='124' y='23' width='1' height='1' xoffset='0' yoffset='0' xadvance='6' page='0' chnl='15' /><char id='33' x='124' y='13' width='2' height='9' xoffset='1' yoffset='4' xadvance='4' page='0' chnl='15' /><char id='34' x='113' y='84' width='5' height='4' xoffset='1' yoffset='4' xadvance='7' page='0' chnl='15' /><char id='35' x='49' y='38' width='8' height='9' xoffset='1' yoffset='4' xadvance='10' page='0' chnl='15' /><char id='36' x='7' y='0' width='6' height='13' xoffset='1' yoffset='2' xadvance='8' page='0' chnl='15' /><char id='37' x='57' y='78' width='7' height='8' xoffset='1' yoffset='5' xadvance='9' page='0' chnl='15' /><char id='38' x='85' y='37' width='7' height='9' xoffset='1' yoffset='4' xadvance='9' page='0' chnl='15' /><char id='39' x='122' y='84' width='2' height='4' xoffset='1' yoffset='4' xadvance='4' page='0' chnl='15' /><char id='40' x='123' y='66' width='4' height='9' xoffset='1' yoffset='4' xadvance='6' page='0' chnl='15' /><char id='41' x='15' y='80' width='4' height='9' xoffset='1' yoffset='4' xadvance='6' page='0' chnl='15' /><char id='42' x='77' y='85' width='7' height='5' xoffset='1' yoffset='6' xadvance='9' page='0' chnl='15' /><char id='43' x='92' y='85' width='6' height='5' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='44' x='119' y='84' width='2' height='4' xoffset='1' yoffset='11' xadvance='4' page='0' chnl='15' /><char id='45' x='49' y='95' width='5' height='1' xoffset='1' yoffset='8' xadvance='7' page='0' chnl='15' /><char id='46' x='125' y='84' width='2' height='2' xoffset='1' yoffset='11' xadvance='4' page='0' chnl='15' /><char id='47' x='101' y='25' width='6' height='10' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='48' x='84' y='57' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='49' x='25' y='79' width='4' height='9' xoffset='1' yoffset='4' xadvance='6' page='0' chnl='15' /><char id='50' x='91' y='57' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='51' x='98' y='56' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='52' x='105' y='56' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='53' x='112' y='56' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='54' x='77' y='57' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='55' x='119' y='56' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='56' x='0' y='70' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='57' x='7' y='70' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='58' x='56' y='87' width='2' height='7' xoffset='1' yoffset='6' xadvance='4' page='0' chnl='15' /><char id='59' x='33' y='79' width='2' height='9' xoffset='1' yoffset='6' xadvance='4' page='0' chnl='15' /><char id='60' x='117' y='66' width='5' height='9' xoffset='1' yoffset='4' xadvance='7' page='0' chnl='15' /><char id='61' x='7' y='98' width='5' height='3' xoffset='1' yoffset='7' xadvance='7' page='0' chnl='15' /><char id='62' x='122' y='46' width='5' height='9' xoffset='1' yoffset='4' xadvance='7' page='0' chnl='15' /><char id='63' x='14' y='70' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='64' x='58' y='37' width='8' height='9' xoffset='1' yoffset='4' xadvance='10' page='0' chnl='15' /><char id='65' x='21' y='69' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='66' x='28' y='69' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='67' x='35' y='69' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='68' x='42' y='68' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='69' x='49' y='68' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='70' x='56' y='68' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='71' x='63' y='67' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='72' x='70' y='67' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='73' x='20' y='80' width='4' height='9' xoffset='1' yoffset='4' xadvance='6' page='0' chnl='15' /><char id='74' x='77' y='67' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='75' x='84' y='67' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='76' x='14' y='60' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='77' x='8' y='50' width='7' height='9' xoffset='1' yoffset='4' xadvance='9' page='0' chnl='15' /><char id='78' x='91' y='67' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='79' x='98' y='66' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='80' x='24' y='49' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='81' x='0' y='27' width='6' height='11' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='82' x='31' y='49' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='83' x='38' y='48' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='84' x='45' y='48' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='85' x='52' y='48' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='86' x='59' y='47' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='87' x='101' y='36' width='7' height='9' xoffset='1' yoffset='4' xadvance='9' page='0' chnl='15' /><char id='88' x='66' y='47' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='89' x='73' y='47' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='90' x='80' y='47' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='91' x='10' y='80' width='4' height='9' xoffset='1' yoffset='4' xadvance='6' page='0' chnl='15' /><char id='92' x='73' y='26' width='6' height='10' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='93' x='5' y='80' width='4' height='9' xoffset='1' yoffset='4' xadvance='6' page='0' chnl='15' /><char id='94' x='105' y='84' width='7' height='4' xoffset='1' yoffset='3' xadvance='9' page='0' chnl='15' /><char id='95' x='43' y='96' width='5' height='1' xoffset='0' yoffset='14' xadvance='5' page='0' chnl='15' /><char id='96' x='32' y='97' width='3' height='2' xoffset='1' yoffset='3' xadvance='5' page='0' chnl='15' /><char id='97' x='107' y='76' width='6' height='7' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='98' x='87' y='47' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='99' x='14' y='90' width='6' height='7' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='100' x='101' y='46' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='101' x='100' y='76' width='6' height='7' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='102' x='105' y='66' width='5' height='9' xoffset='1' yoffset='4' xadvance='7' page='0' chnl='15' /><char id='103' x='109' y='36' width='7' height='9' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='104' x='108' y='46' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='105' x='122' y='25' width='4' height='10' xoffset='1' yoffset='3' xadvance='6' page='0' chnl='15' /><char id='106' x='21' y='14' width='6' height='12' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='107' x='115' y='46' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='108' x='0' y='80' width='4' height='9' xoffset='1' yoffset='4' xadvance='6' page='0' chnl='15' /><char id='109' x='76' y='77' width='8' height='7' xoffset='1' yoffset='6' xadvance='10' page='0' chnl='15' /><char id='110' x='93' y='77' width='6' height='7' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='111' x='114' y='76' width='6' height='7' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='112' x='0' y='60' width='6' height='9' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='113' x='7' y='60' width='6' height='9' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='114' x='35' y='89' width='6' height='7' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='115' x='7' y='90' width='6' height='7' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='116' x='111' y='66' width='5' height='9' xoffset='1' yoffset='4' xadvance='7' page='0' chnl='15' /><char id='117' x='0' y='90' width='6' height='7' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='118' x='121' y='76' width='6' height='7' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='119' x='85' y='77' width='7' height='7' xoffset='1' yoffset='6' xadvance='9' page='0' chnl='15' /><char id='120' x='21' y='90' width='6' height='7' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='121' x='94' y='46' width='6' height='9' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='122' x='28' y='89' width='6' height='7' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='123' x='21' y='59' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='124' x='30' y='79' width='2' height='9' xoffset='1' yoffset='4' xadvance='4' page='0' chnl='15' /><char id='125' x='28' y='59' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='126' x='13' y='98' width='7' height='2' xoffset='1' yoffset='7' xadvance='9' page='0' chnl='15' /><char id='160' x='126' y='56' width='1' height='1' xoffset='0' yoffset='0' xadvance='6' page='0' chnl='15' /><char id='161' x='125' y='36' width='2' height='9' xoffset='1' yoffset='6' xadvance='4' page='0' chnl='15' /><char id='162' x='35' y='59' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='163' x='16' y='49' width='7' height='9' xoffset='1' yoffset='4' xadvance='9' page='0' chnl='15' /><char id='165' x='42' y='58' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='166' x='36' y='79' width='2' height='9' xoffset='1' yoffset='4' xadvance='4' page='0' chnl='15' /><char id='168' x='21' y='98' width='6' height='2' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='169' x='48' y='78' width='8' height='8' xoffset='1' yoffset='5' xadvance='10' page='0' chnl='15' /><char id='171' x='59' y='87' width='8' height='5' xoffset='1' yoffset='6' xadvance='10' page='0' chnl='15' /><char id='172' x='0' y='98' width='6' height='3' xoffset='1' yoffset='8' xadvance='8' page='0' chnl='15' /><char id='174' x='39' y='79' width='8' height='8' xoffset='1' yoffset='5' xadvance='10' page='0' chnl='15' /><char id='176' x='99' y='85' width='5' height='5' xoffset='1' yoffset='3' xadvance='7' page='0' chnl='15' /><char id='177' x='42' y='88' width='6' height='7' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='180' x='28' y='97' width='3' height='2' xoffset='1' yoffset='3' xadvance='5' page='0' chnl='15' /><char id='181' x='49' y='58' width='6' height='9' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='182' x='0' y='50' width='7' height='9' xoffset='1' yoffset='4' xadvance='9' page='0' chnl='15' /><char id='183' x='40' y='97' width='2' height='2' xoffset='1' yoffset='7' xadvance='4' page='0' chnl='15' /><char id='184' x='36' y='97' width='3' height='2' xoffset='1' yoffset='13' xadvance='5' page='0' chnl='15' /><char id='187' x='68' y='85' width='8' height='5' xoffset='1' yoffset='6' xadvance='10' page='0' chnl='15' /><char id='191' x='56' y='58' width='6' height='9' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='192' x='73' y='0' width='6' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='193' x='42' y='14' width='6' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='194' x='42' y='0' width='6' height='13' xoffset='1' yoffset='0' xadvance='8' page='0' chnl='15' /><char id='195' x='65' y='0' width='7' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='196' x='87' y='0' width='6' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='197' x='28' y='0' width='6' height='13' xoffset='1' yoffset='0' xadvance='8' page='0' chnl='15' /><char id='198' x='38' y='38' width='10' height='9' xoffset='1' yoffset='4' xadvance='12' page='0' chnl='15' /><char id='199' x='108' y='0' width='6' height='12' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='200' x='28' y='14' width='6' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='201' x='49' y='13' width='6' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='202' x='35' y='0' width='6' height='13' xoffset='1' yoffset='0' xadvance='8' page='0' chnl='15' /><char id='203' x='94' y='0' width='6' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='204' x='122' y='0' width='4' height='12' xoffset='1' yoffset='1' xadvance='6' page='0' chnl='15' /><char id='205' x='77' y='13' width='4' height='12' xoffset='1' yoffset='1' xadvance='6' page='0' chnl='15' /><char id='206' x='14' y='0' width='6' height='13' xoffset='0' yoffset='0' xadvance='6' page='0' chnl='15' /><char id='207' x='101' y='0' width='6' height='12' xoffset='0' yoffset='1' xadvance='6' page='0' chnl='15' /><char id='208' x='93' y='36' width='7' height='9' xoffset='0' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='209' x='57' y='0' width='7' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='210' x='63' y='13' width='6' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='211' x='80' y='0' width='6' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='212' x='0' y='0' width='6' height='13' xoffset='1' yoffset='0' xadvance='8' page='0' chnl='15' /><char id='213' x='49' y='0' width='7' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='214' x='70' y='13' width='6' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='215' x='85' y='85' width='6' height='5' xoffset='1' yoffset='7' xadvance='8' page='0' chnl='15' /><char id='216' x='67' y='37' width='8' height='9' xoffset='0' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='217' x='35' y='14' width='6' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='218' x='14' y='14' width='6' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='219' x='21' y='0' width='6' height='13' xoffset='1' yoffset='0' xadvance='8' page='0' chnl='15' /><char id='220' x='7' y='14' width='6' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='221' x='0' y='14' width='6' height='12' xoffset='1' yoffset='1' xadvance='8' page='0' chnl='15' /><char id='222' x='63' y='57' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='223' x='70' y='57' width='6' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='224' x='87' y='25' width='6' height='10' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='225' x='94' y='25' width='6' height='10' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='226' x='110' y='13' width='6' height='11' xoffset='1' yoffset='2' xadvance='8' page='0' chnl='15' /><char id='227' x='14' y='27' width='7' height='10' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='228' x='45' y='27' width='6' height='10' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='229' x='82' y='13' width='6' height='11' xoffset='1' yoffset='2' xadvance='8' page='0' chnl='15' /><char id='230' x='65' y='77' width='10' height='7' xoffset='1' yoffset='6' xadvance='12' page='0' chnl='15' /><char id='231' x='59' y='26' width='6' height='10' xoffset='1' yoffset='6' xadvance='8' page='0' chnl='15' /><char id='232' x='108' y='25' width='6' height='10' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='233' x='21' y='38' width='6' height='10' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='234' x='7' y='27' width='6' height='11' xoffset='1' yoffset='2' xadvance='8' page='0' chnl='15' /><char id='235' x='115' y='25' width='6' height='10' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='236' x='33' y='38' width='4' height='10' xoffset='1' yoffset='3' xadvance='6' page='0' chnl='15' /><char id='237' x='28' y='38' width='4' height='10' xoffset='1' yoffset='3' xadvance='6' page='0' chnl='15' /><char id='238' x='117' y='13' width='6' height='11' xoffset='0' yoffset='2' xadvance='6' page='0' chnl='15' /><char id='239' x='0' y='39' width='6' height='10' xoffset='0' yoffset='3' xadvance='6' page='0' chnl='15' /><char id='240' x='117' y='36' width='7' height='9' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='241' x='22' y='27' width='7' height='10' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='242' x='7' y='39' width='6' height='10' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='243' x='14' y='38' width='6' height='10' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='244' x='103' y='13' width='6' height='11' xoffset='1' yoffset='2' xadvance='8' page='0' chnl='15' /><char id='245' x='30' y='27' width='7' height='10' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='246' x='38' y='27' width='6' height='10' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='247' x='49' y='87' width='6' height='7' xoffset='1' yoffset='5' xadvance='8' page='0' chnl='15' /><char id='248' x='76' y='37' width='8' height='9' xoffset='0' yoffset='5' xadvance='8' page='0' chnl='15' /><char id='249' x='52' y='26' width='6' height='10' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='250' x='66' y='26' width='6' height='10' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='251' x='96' y='13' width='6' height='11' xoffset='1' yoffset='2' xadvance='8' page='0' chnl='15' /><char id='252' x='80' y='26' width='6' height='10' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='253' x='115' y='0' width='6' height='12' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /><char id='254' x='89' y='13' width='6' height='11' xoffset='1' yoffset='4' xadvance='8' page='0' chnl='15' /><char id='255' x='56' y='13' width='6' height='12' xoffset='1' yoffset='3' xadvance='8' page='0' chnl='15' /></chars></font>"
    },
    {
        "id" : 9,
        "name" : "simpleWalk",
        "type" : "spritesheet",
        "fileName" : "simpleWalk.png",
        "frames" : {
            "x" : 32,
            "y" : 32
        }
    },
    {
        "id" : 10,
        "name" : "door",
        "type" : "image",
        "fileName" : "Door.png",
        "size" : { "x" : 32, "y" : 32 }
    }    
]
;});

define('src/GameState/PreLoadAssets',['underscore','json!data/assets.json','phaser'],function(_,assets,Phaser){

    var PreLoadAssets = function(game){
        console.log("Preload ctor:",game);
        this.game = game;
    };

    PreLoadAssets.prototype.preload = function(){
        console.log("Preloading");
        //Load everything speciied in the assets json
        assets.forEach(function(asset){
            if(asset.type === "image"){
                this.game.load.image(asset.name,"data/"+asset.fileName);
            }else if(asset.type === "spritesheet"){
                this.game.load.spritesheet(asset.name,"data/"+asset.fileName,asset.frames.x,asset.frames.y);
            }else if(asset.type === "bitmapfont"){
                this.game.load.bitmapFont(asset.name,asset.url,null,asset.data);
            }else{
                console.log("Unknown asset type: ",asset);
            }
        },this);
        console.log("Loaded:",assets);
    };

    PreLoadAssets.prototype.create = function(){
        //Everything has been loaded, go to the actual game
        this.game.state.start('GameState');
    };

    PreLoadAssets.prototype.update = function(){

    };


    return PreLoadAssets;
});


define("json!data/scene1.json", function(){ return [ 
    {
        "id" : 0,
        "name" : "room1",
        "origin" : true,
        "connections" : {
            "left": null,
            "right": 1,
            "down" : null,
            "up"  : null
        },
        "background" : "countryBackground",
        "backgroundFrame" : null,
        "doors" : [
            {
                "name" : "rightDoor",
                "connectsTo" : "right",
                "assetName" : "door",
                "position" : {
                    "x" : 940,
                    "y" : 530                    
                },
                "size" : { "x" : 70, "y" : 100 }
            }
        ],
        "walls" : [
            {
                "name" : "leftWall",
                "assetName" : "simpleTile",
                "type" : "tileSprite",
                "position" : {
                    "x" : 25,
                    "y" : 0
                },
                "height" : 600,
                "width" : 20
            },
            {
                "name" : "rightWall",
                "assetName" : "simpleTile",
                "position" : {
                    "x" : 950,
                    "y" : 0
                },
                "height" : 600,
                "width" : 20
            },
            {
                "name" : "floor",
                "assetName" : "simpleTile",
                "position" : {
                    "x" : 0,
                    "y" : 550
                },
                "height" : 20,
                "width" : 1000                
            }
        ],
        "items" : [
            {
                "name" : "tree1",
                "assetName" : "tree",
                "frame" : 49,
                "position" : {
                    "x" : 0,
                    "y" : 600
                },
                "group" : "treesForeground",
                "physical" : false
            },
            {
                "name" : "tree2",
                "assetName" : "tree",
                "frame" : 15,
                "position" : {
                    "x" : 600,
                    "y" : 550
                },
                "group" : "treesForeground",
                "physical" : false
            },
            {
                "name" : "tree3",
                "assetName" : "tree",
                "frame" : 2,
                "position" : {
                    "x" : 800,
                    "y" : 499
                },
                "group" : "treesBackground",
                "physical" : false
            },
            {
                "name" : "rock1",
                "assetName" : "rock",
                "physical" : true,
                "position" : {
                    "x" : 400,
                    "y" : 550
                },
                "group" : "objects",
                "immovable" : true,
                "invisible" : false
            }
        ],
        "actors" : [
            {
                "name" : "bob",
                "assetName" : "pig",
                "frame" : 1,
                "position" : {
                    "x" : 50,
                    "y" : 450
                },
                "group" : "actors",
                "physical" : true,
                "controllable" : true,
                "facing" : "right",
                "animations" : {
                    "walk" : ["simpleWalk",6]
                },
                "dimensions" : {
                    "width" : 100,
                    "height" : 100
                }
            },
            {
                "name" : "bill",
                "assetName" : "pig",
                "frame" : 15,
                "position" : {
                    "x" : 300,
                    "y" : 450
                },
                "group" : "actors",
                "physical" : true,
                "facing" : "left"
            }

        ]            
    },
    {
        "id" : 1,
        "name" : "room2",
        "connections" : {
            "left" : 0,
            "right" : null,
            "down" : null,
            "up" : null
        },
        "background" : "simpleTile",
        "backgroundFrame" : null,
        "doors" : [
            {
                "name" : "leftDoor",
                "connectsTo" : "left",
                "assetName" : "door",
                "position" : {
                    "x" : 60,
                    "y" : 530
                },
                "size" : { "x" : 70, "y" : 100 }
            },
            {
                "name" : "rightDoor",
                "connectsTo" : "left",
                "assetName" : "door",
                "position" : {
                    "x" : 960,
                    "y" : 530
                },
                "size" : { "x" : 70, "y" : 100}
            }
        ],
        "walls" : [
            {
                "name" : "leftWall",
                "assetName" : "simpleTile",
                "type" : "tileSprite",
                "position" : {
                    "x" : 25,
                    "y" : 0
                },
                "height" : 600,
                "width" : 20
            },
            {
                "name" : "rightWall",
                "assetName" : "simpleTile",
                "position" : {
                    "x" : 950,
                    "y" : 0
                },
                "height" : 600,
                "width" : 20
            },
            {
                "name" : "floor",
                "assetName" : "simpleTile",
                "position" : {
                    "x" : 0,
                    "y" : 550
                },
                "height" : 20,
                "width" : 1000                
            }
        ],
        "items" : [
            {
                "name" : "tree1",
                "assetName" : "tree",
                "frame" : 49,
                "position" : {
                    "x" : 0,
                    "y" : 600
                },
                "group" : "treesForeground",
                "physical" : false
            },
            {
                "name" : "tree2",
                "assetName" : "tree",
                "frame" : 34,
                "position" : {
                    "x" : 550,
                    "y" : 550
                },
                "group" : "treesBackground",
                "physical" : false
                
            }
            
        ],
        "actors" : [

        ]
    }
]
;});

//From http://jsfiddle.net/lewster32/81pzgs4z/

define('src/Extensions/SpeechBubble',['underscore','phaser'],function(_,Phaser){

    var SpeechBubble = function(game,x,y,width,text){
        Phaser.Sprite.call(this,game,x,y);

        // Some sensible minimum defaults
        width = width || 27;
        var height = 18;

        // Set up our text and run our custom wrapping routine on it
        this.bitmapText = game.make.bitmapText(x + 12, y + 4, '8bitoperator', text, 22);
        SpeechBubble.wrapBitmapText(this.bitmapText, width);

        // Calculate the width and height needed for the edges
        var bounds = this.bitmapText.getLocalBounds();
        if (bounds.width + 18 > width) {
            width = bounds.width + 18;
        }
        if (bounds.height + 14 > height) {
            height = bounds.height + 14;
        }

        // Create all of our corners and edges
        this.borders = [
            game.make.tileSprite(x + 9, y + 9, width - 9, height - 9, 'bubble-border', 4),
            game.make.image(x, y, 'bubble-border', 0),
            game.make.image(x + width, y, 'bubble-border', 2),
            game.make.image(x + width, y + height, 'bubble-border', 8),
            game.make.image(x, y + height, 'bubble-border', 6),
            game.make.tileSprite(x + 9, y, width - 9, 9, 'bubble-border', 1),
            game.make.tileSprite(x + 9, y + height, width - 9, 9, 'bubble-border', 7),
            game.make.tileSprite(x, y + 9, 9, height - 9, 'bubble-border', 3),
            game.make.tileSprite(x + width, y + 9, 9, height - 9, 'bubble-border', 5)
        ];

        // Add all of the above to this sprite
        for (var b = 0, len = this.borders.length; b < len; b++) {
            this.addChild(this.borders[b]);
        }

        // Add the tail
        this.tail = this.addChild(game.make.image(x + 18, y + 3 + height, 'bubble-tail'));

        // Add our text last so it's on top
        this.addChild(this.bitmapText);
        this.bitmapText.tint = 0x111111;

        // Offset the position to be centered on the end of the tail
        this.pivot.set(x + 25, y + height + 24);

    };
    SpeechBubble.prototype = Object.create(Phaser.Sprite.prototype);
    SpeechBubble.prototype.constructor = SpeechBubble;

    SpeechBubble.wrapBitmapText = function (bitmapText, maxWidth) {
        var words = bitmapText.text.split(' '), output = "", test = "";

        for (var w = 0, len = words.length; w < len; w++) {
            test += words[w] + " ";
            bitmapText.text = test;
            bitmapText.updateText();
            if (bitmapText.textWidth > maxWidth) {
                output += "\n" + words[w] + " ";
            }
            else {
                output += words[w] + " ";
            }
            test = output;
        }

        output = output.replace(/(\s)$/gm, ""); // remove trailing spaces
        bitmapText.text = output;
        bitmapText.updateText();
    };

    return SpeechBubble;
});


define('src/Extensions/Actor',['underscore','./SpeechBubble','phaser'],function(_,SpeechBubble,Phaser){

    var Actor = function(game,x,y,key,frame,name,facing,controllable,width,height){
        console.log(name);
        Phaser.Sprite.call(this,game,x,y,key,frame);
        this.name = name;
        this.defaultTexture = key;
        this.currentTexture = key;
        this.inventory = {};
        this.facing = facing || 'right';
        this.controllable = controllable || false;
        this.anchor.setTo(.5,1);
        this.width = width || this.width;
        this.height = height || this.height;
        this.jumpTimer = 0;
        
        if(this.facing === "left") this.flip();
        
        //Speech bubble:
        this.speechBubble = null;

        //animations
        this.registeredAnimations = {};
        
    };
    Actor.prototype = Object.create(Phaser.Sprite.prototype);
    Actor.prototype.constructor = Actor;

    Actor.prototype.updateTexture = function(name){
        if(this.currentTexture === name) return false;
        this.currentTexture = name;
        this.loadTexture(name);
        return true;
    };

    Actor.prototype.setupAnimation = function(name,animation){
        if(animation && this.updateTexture(animation[0])){
            this.animations.add(name);
        }        
    };
    
    Actor.prototype.flip = function(){
        if(this.facing === "right") {
            this.facing = "left";
        }else{
            this.facing = "right";
        }
        this.scale.x *= -1;
        if(this.speechBubble) this.speechBubble.scale.x *= -1;
    }

    Actor.prototype.say = function(text){
        if(text === undefined && this.speechBubble !== null){
            this.removeChild(this.speechBubble);
            this.speechBubble = null;
        }else if(this.speechBubble === null){
            console.log("Creating speech bubble of: " + text);
            this.speechBubble = new SpeechBubble(this.game,0,-50,256,text);
            this.addChild(this.speechBubble);
        }
    };
    
    Actor.prototype.move = function(direction,strength){
        if(direction === undefined){
            this.body.velocity.x *= 0.5;
        }
        if(strength === undefined) strength = 150;
        
        if(direction === 'down'){
            this.body.velocity.y += strength;
        }else if(direction === 'up' &&  this.game.time.now > this.jumpTimer){
            this.body.velocity.y = -250;
            this.jumpTimer = this.game.time.now + 750;
        }else if(direction === 'right'){
            this.body.velocity.x += strength;
            this.setupAnimation('walk',this.registeredAnimations['walk']);
            if(this.facing === 'left'){
                this.flip();
            }
        }else if(direction === 'left'){
            this.body.velocity.x -= strength;
            this.setupAnimation('walk',this.registeredAnimations['walk']);
            if(this.facing === 'right'){
                this.flip();
            }
        }

        if(Math.abs(this.body.velocity.x) < 25){
            this.animations.stop();
            //this.updateTexture(this.defaultTexture);
        }else{
            if(this.registeredAnimations['walk'] !== undefined){
                this.animations.play('walk',this.registeredAnimations['walk'][1]);
            }
        }
        
    };


    //update/AI
    Actor.prototype.update = function(externalInformation){
        if(this.body.velocity.x < 15){
            console.log("Updating: ",this.name);
            var moveDir = _.sample(['left','right'],1);
            this.move(moveDir[0]);
        }

    };

    
    
    return Actor;
});


define('src/Extensions/Item',['underscore','phaser'],function(_,Phaser){

    var Item = function(game,x,y,key,frame,name){
        console.log(x,y,key,frame,name);
        Phaser.Sprite.call(this,game,x,y,key,frame);
        this.name = name;
    };
    Item.prototype = Object.create(Phaser.Sprite.prototype);
    Item.prototype.constructor = Item;


    
    return Item;
});

define('src/Extensions/Door',['underscore','phaser'],function(_,Phaser){

    var Door = function(game,x,y,key,name,connection){
        Phaser.Sprite.call(this,game,x,y,key);
        this.name = name;
        this.connection = connection;
    };
    Door.prototype = Object.create(Phaser.Sprite.prototype);
    Door.prototype.constructor = Door;

    return Door;
    
});


define('src/Extensions/Room',['underscore','./Actor','./Item','./Door','phaser'],function(_,Actor,Item,Door,Phaser){

    var Room = function(game,description){
        Phaser.Group.call(this,game,null,description.name);

        //Create the background:
        var background = new Phaser.Sprite(this.game,0,0,description.background,description.backgroundFrame);
        background.width = this.game.width;
        background.height = this.game.height;
        this.add(background);
        
        this.id = description.id;
        this.connections = description.connections;
        //this.width = this.game.width;
        //this.height = this.game.height;
        this.actors = {};
        this.groups = {};

        //Build the room:
        //walls
        description.walls.forEach(d=>this.buildWall(d));
        // //doors
        description.doors.forEach(d=>this.buildDoor(d));
        //items
        description.items.forEach(d=>this.buildItem(d));
        //actors
        description.actors.forEach(d=>this.buildActor(d));

        
        // //todo:build the floor, ceiling, and walls
        // //TODO: sort items by y value
        // room.items.sort(function(a,b){
        //     return a.position.y - b.position.y;
        // });
        
        // var pre = room.items.filter(function(d){
        //     return d.position.y < this.game.height - 75;
        // },this);

        // var post = room.items.filter(function(d){
        //     return d.position.y >= this.game.height - 75;
        // },this);

        // console.log("Filtered:",pre,post);
        
        // pre.forEach(function(d){
        //     this.buildItem(d);
        // },this);

        // post.forEach(function(d){
        //     this.buildItem(d);
        // },this);


        
    };
    
    Room.prototype = Object.create(Phaser.Group.prototype);
    Room.prototype.constructor = Room;

    Room.prototype.buildWall = function(wallDesc){
        if(this.groups['walls'] === undefined) this.groups['walls'] = new Phaser.Group(this.game,this,'walls');

        //Each wall is a tilesprite stretch for the defined size
        var tileSprite = new Phaser.TileSprite(this.game,wallDesc.position.x,wallDesc.position.y,
                                               wallDesc.width,wallDesc.height,wallDesc.assetName,wallDesc.frame);
        this.groups['walls'].add(tileSprite);

        this.game.physics.enable(tileSprite);
        tileSprite.body.immovable = true;
        tileSprite.body.allowGravity = false;
        
        
    };

    Room.prototype.buildDoor = function(d){
        console.groupCollapsed();
        
        console.log("Building door:",d);
        d.group = "doors";

        var parent = undefined;
        if(d.invisible) parent = null;

        if(this.groups[d.group] === undefined){
            var newGroup = new Phaser.Group(this.game,this,d.group,false,d.physical,this.physicsType);
            this.groups[d.group] = newGroup;
        }

        var door = new Door(this.game,d.position.x,d.position.y,d.assetName,d.name,d.connectsTo);
        door.height = d.size.y;
        door.width = d.size.x;
        
        this.groups[d.group].add(door);
        door.anchor.setTo(0.5,1);

        this.game.physics.enable(door);
        door.body.collideWorldBounds = true;
        door.body.immovable = true;
        door.body.allowGravity = false;
        
        console.groupEnd();
    };
    
    Room.prototype.buildItem = function(d){
        console.groupCollapsed();
        console.log("building Item:",d);
        //if there is no group defined:
        if(d.group === undefined) d.group = "default";
        if(d.physical === undefined) d.physical = false;
        //create the group if necessary
        var parent = undefined;
        if(d.invisible) parent = null;
        
        if(this.groups[d.group] === undefined){
            console.log("creating group: ",d.group);
            var newGroup = new Phaser.Group(this.game,this,d.group,false,d.physical,this.physicsType);
            this.groups[d.group] = newGroup;
        }
        
        var item = new Item(this.game,d.position.x,d.position.y,d.assetName,d.frame,d.name);
        this.groups[d.group].add(item);
        item.anchor.setTo(0.5,1);
        
        if(d.physical){
            this.game.physics.enable(item);
            item.body.collideWorldBounds = true;
            if(d.immovable){
                item.body.immovable = d.immovable;
                item.body.allowGravity = false;
            }
        }

        console.groupEnd();
    };

    Room.prototype.buildActor = function(d){
        console.groupCollapsed();
        
        //TODO: customise the group.classType for custom classes
        var actor = new Actor(this.game,d.position.x,d.position.y,d.assetName,d.frame,d.name,d.facing,d.controllable,d.width,d.height);

        if(d.dimensions){
            actor.height = d.dimensions.height;
            actor.width = d.dimensions.width;
        }
        
        if(d.physical){
            this.game.physics.enable(actor);
            actor.body.collideWorldBounds = true;
            actor.body.fixedRotation = true;
            actor.body.bounce.y = 0.2;
        }

        //if the actor is defined to have any animations:
        _.keys(d.animations).forEach(function(e){
            actor.registeredAnimations[e] = d.animations[e];
        });

        this.addActor(actor);

        console.log(this.groups);
        console.groupEnd();
    };

    Room.prototype.update = function(){
        var roomRef = this;
        //check for collisions
        if(this.groups.actors !== undefined){
            this.game.physics.arcade.collide(this.groups.actors,this.groups.actors);
            this.game.physics.arcade.collide(this.groups.actors,this.groups.objects);
            this.game.physics.arcade.collide(this.groups.actors,this.groups.walls);
            this.game.physics.arcade.collide(this.groups.actors,this.groups.doors,function(actor,door){
                if(!actor.controllable){
                    //move the actor through the door
                    roomRef.game.world.remove(actor);
                    delete roomRef.actors[actor.name];
                    var room = roomRef.getRoomFromDoor(door);
                    room.addActor(actor);
                }else{
                    //get the room using the door's connection
                    var room = roomRef.getRoomFromDoor(door);
                    roomRef.game.state.getCurrentState().changeRoom(room);
                 
                }
            });
        }
        this.game.physics.arcade.collide(this.groups.walls,this.groups.objects);
        
        //run AI for each actor
        _.values(this.actors).forEach(function(d){
            if(!d.controllable){
                d.update();
            }
        });

        
        //perform movements

        //perform interactions

    };


    Room.prototype.getRoomFromDoor = function(door){
        var roomId = this.connections[door.connection];
        return this.game.state.getCurrentState().rooms[roomId];
    };

    //
    Room.prototype.addActor = function(actor,group,physical,physicsType){
        if(group === undefined) group = "actors";
        if(physical === undefined) physical = true;
        if(physicsType === undefined) physicsType = "arcade";

        //create the group if necessary
        if(this.groups[group] === undefined){
            console.log("Creating group:",group);
            var newGroup = new Phaser.Group(this.game,this,group,false,physical,physicsType);
            this.groups[group] = newGroup;
        }

        this.groups[group].add(actor);
        this.actors[actor.name] = actor;
        
    };
    
    
    return Room;

});

define('src/GameState/GameState',['json!data/scene1.json','underscore','../Extensions/SpeechBubble','../Extensions/Actor','../Extensions/Room','phaser'],function(scene,_,SpeechBubble,Actor,Room,Phaser){

    /**
       @class GameState
       @constructor
       @purpose main state of a game. In this case, 2d side scroll platform like.
     */
    var GameState = function(game,scene){
        this.physicsType = Phaser.Physics.ARCADE;
        
        this.game = game;
        this.gravityAmnt = 350;
        //Current State info:
        this.currentRoom = null;
        this.controllableActor = null;

        //All available info:
        this.rooms = {};
        this.actors = {};

        //Reasoning / AI
        this.rete = null;

        if(scene !== undefined){
            this.scene = scene;
        }
    };

    /**
       @class GameState
       @method init
       @purpose called on creation, after ctor
     */
    GameState.prototype.init = function(){
        console.log("GameState init");
        //Setup the reasoning system / RETE
    };

    /**
       @class GameState
       @method preload
       @purpose loads assets
     */
    GameState.prototype.preload = function(){
        console.log("GameState preload");
        //this.scene.forEach(function(room){
            //create the room groups and store them
        //});
        
    };

    /**
       @class GameState
       @method create
       @purpose called when this state becomes active
     */
    GameState.prototype.create = function(){
        console.log("GameState create");
        this.game.time.desiredFps = 30;
        this.cursors = this.game.input.keyboard.createCursorKeys();
        //setup physics:
        this.game.physics.startSystem(Phaser.Physics.ARCADE);
        this.game.physics.arcade.gravity.y = this.gravityAmnt;

        //Create each room,
        //and add the origin room
        scene.forEach(function(d){
            var newRoom = this.buildRoom(d);
            if(d.origin){
                this.currentRoom = newRoom;
                this.game.world.add(newRoom);
            }
        },this);

        //set the controllable character:
        var actors = _.values(this.currentRoom.actors);
        this.controllableActor = _.find(_.values(actors),function(d){ return d.controllable === true; });
        console.log("set controllable actor to:",this.controllableActor);
        
        //Set world boundaries
        //this.physics.arcade.setBounds(0,0,this.game.width,this.game.height-75);

    };

    /**
       @class GameState
       @method update
       @purpose called each tick
     */
    GameState.prototype.update = function(){

        this.currentRoom.update();
        if(this.controllableActor){
            this.controllableActor.move();
        
            //get the cursor keys, move the playable character as necessary
            //get interaction key
            //run reasoning for each character, register actions for them to perform
            if(this.cursors.up.isDown){
                this.controllableActor.move('up');
            }else if(this.cursors.down.isDown){
                this.controllableActor.move('down');
            }
            if(this.cursors.left.isDown){
                this.controllableActor.move('left');
            }else if(this.cursors.right.isDown){
                this.controllableActor.move('right');
            }
        }
    };

    //------------------------------
    
    /**
       @class GameState
       @method buildRoom
       @purpose takes a description of a room and instantiates it for display and game logic
     */
    
    GameState.prototype.buildRoom = function(room){
        console.log("Building Room:",room);
        var newRoom = new Room(this.game,room);
        this.rooms[newRoom.id] = newRoom;
        return newRoom;
    };


    GameState.prototype.changeRoom = function(room){
        if(this.currentRoom !== null){
            this.game.world.remove(this.controllableActor);
            this.game.world.remove(this.currentRoom);
        }

        //get the room
        if(room){
            this.currentRoom = room;
            this.game.world.add(room);
            this.currentRoom.addActor(this.controllableActor);
        }else{
            console.log(room,this.rooms);
            throw new Error("room is null");
        }
        console.log("Current Room:",this.currentRoom);
    };

    return GameState;
});

define('src/phaserGame',['underscore','src/GameState/Boot','src/GameState/PreLoadAssets','src/GameState/GameState','phaser'],function(_,Boot,PreLoadAssets,GameState,Phaser){

    var PhaserGame = function(xSize,ySize,domElement){
        this.game = new Phaser.Game(xSize,ySize,Phaser.AUTO,domElement);

        //States to add: boot, preload, GameState
        //TODO: load game states parameterised from the scene json?
        this.game.state.add('Boot',Boot);
        this.game.state.add('PreLoadAssets',PreLoadAssets);
        this.game.state.add('GameState',GameState);
        
        //Global stuff to set:
        //game.physics.startSystem(Phaser.Physics.ARCADE);
        this.game.state.start('Boot');
    };

    return PhaserGame;
});

define('underscore',function() { return _; }); 
define('phaser',function(){return Phaser; }); 
return require('src/phaserGame'); }));